<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown Polisher</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      background: #f0f2f5;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #1a1a2e;
      color: #fff;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.25);
    }
    header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: .02em;
    }
    header .subtitle {
      font-size: .8rem;
      color: #aab4c8;
      margin-left: auto;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      max-width: 1600px;
      width: 100%;
      margin: 0 auto;
    }

    /* â”€â”€ Input panes â”€â”€ */
    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .pane {
      display: flex;
      flex-direction: column;
      background: #fff;
      border: 1px solid #dde1e7;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,.06);
    }
    .pane-header {
      background: #f7f8fa;
      border-bottom: 1px solid #dde1e7;
      padding: 8px 14px;
      font-weight: 600;
      font-size: .82rem;
      color: #555;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pane-header .badge {
      background: #e0e7ff;
      color: #3730a3;
      border-radius: 4px;
      padding: 1px 6px;
      font-size: .72rem;
    }
    .pane textarea {
      flex: 1;
      resize: none;
      border: none;
      outline: none;
      font-family: 'Consolas', 'Menlo', 'Monaco', monospace;
      font-size: .82rem;
      line-height: 1.55;
      padding: 12px 14px;
      color: #1a1a2e;
      background: transparent;
      min-height: 280px;
    }

    .file-btn {
      margin-left: auto;
      padding: 3px 10px;
      font-size: .75rem;
      font-weight: 500;
      background: #fff;
      border: 1px solid #dde1e7;
      color: #666;
      transition: background .15s, border-color .15s, color .15s;
    }
    .file-btn:hover {
      background: #e0e7ff;
      border-color: #a5b4fc;
      color: #3730a3;
    }

    .pane.drag-over {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79,70,229,.15);
    }
    .pane.drag-over textarea {
      background: #eef2ff;
    }

    /* â”€â”€ Controls bar â”€â”€ */
    .controls-bar {
      background: #fff;
      border: 1px solid #dde1e7;
      border-radius: 8px;
      padding: 14px 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,.06);
      display: flex;
      align-items: flex-start;
      gap: 24px;
      flex-wrap: wrap;
    }

    .controls-bar .section-title {
      font-weight: 700;
      font-size: .78rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 8px;
    }

    .checkboxes {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 32px;
      flex: 1;
    }

    .checkboxes label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: .85rem;
      user-select: none;
    }
    .checkboxes label:hover { color: #3730a3; }
    .checkboxes input[type="checkbox"] {
      width: 15px;
      height: 15px;
      accent-color: #4f46e5;
      cursor: pointer;
    }
    .checkboxes .feature-num {
      font-size: .7rem;
      background: #4f46e5;
      color: #fff;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      justify-content: flex-start;
    }

    button {
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: .88rem;
      font-weight: 600;
      padding: 10px 28px;
      transition: background .15s, transform .1s;
    }
    button:active { transform: scale(.97); }

    #convert-btn {
      background: #4f46e5;
      color: #fff;
      box-shadow: 0 2px 8px rgba(79,70,229,.35);
    }
    #convert-btn:hover { background: #4338ca; }

    #copy-btn {
      background: #f0fdf4;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    #copy-btn:hover { background: #dcfce7; }
    #copy-btn:disabled {
      opacity: .45;
      cursor: default;
    }

    /* â”€â”€ Error message â”€â”€ */
    #error-msg {
      display: none;
      background: #fef2f2;
      border: 1px solid #fca5a5;
      color: #991b1b;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: .85rem;
      line-height: 1.5;
      white-space: pre-line;
    }

    /* â”€â”€ Output pane â”€â”€ */
    .output-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .output-label {
      font-weight: 700;
      font-size: .82rem;
      color: #555;
      padding-left: 2px;
    }
    #output {
      width: 100%;
      min-height: 300px;
      resize: vertical;
      background: #fff;
      border: 1px solid #dde1e7;
      border-radius: 8px;
      padding: 12px 14px;
      font-family: 'Consolas', 'Menlo', 'Monaco', monospace;
      font-size: .82rem;
      line-height: 1.55;
      color: #1a1a2e;
      outline: none;
      box-shadow: 0 1px 3px rgba(0,0,0,.06);
    }

    .cb-wrapper { flex: 1; }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 720px) {
      .input-row { grid-template-columns: 1fr; }
      .checkboxes { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <h1>ğŸ“ Markdown Polisher</h1>
  <span class="subtitle">Google ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ â†’ Markdown å¤‰æ›å¾Œãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ãƒ„ãƒ¼ãƒ«</span>
</header>

<main>

  <!-- Input panes -->
  <div class="input-row">
    <div class="pane" id="latex-pane">
      <div class="pane-header">
        <span class="badge">LaTeX å…¥åŠ›</span>
        <button class="file-btn" id="latex-file-btn">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
        <input type="file" id="latex-file-input" accept=".txt,.tex,.latex" hidden>
      </div>
      <textarea id="latex-input" placeholder="LaTeXå½¢å¼ã®æ•°å¼ã‚’å«ã‚€ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚&#10;ä¾‹: $X$ ã‚„ $$Attention(Q,K,V)=...$$"></textarea>
    </div>
    <div class="pane" id="markdown-pane">
      <div class="pane-header">
        <span class="badge">Markdown å…¥åŠ›</span>
        <button class="file-btn" id="markdown-file-btn">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
        <input type="file" id="markdown-file-input" accept=".txt,.md" hidden>
      </div>
      <textarea id="markdown-input" placeholder="Google ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰å¤‰æ›ã—ãŸ Markdown ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚&#10;ä¾‹: ![][image1] ã‚„ [image1]: &lt;data:image/png;base64,...&gt;"></textarea>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls-bar">
    <div class="cb-wrapper">
      <div class="section-title">å®Ÿè¡Œã™ã‚‹æ©Ÿèƒ½ï¼ˆãƒã‚§ãƒƒã‚¯ã‚’ã¯ãšã™ã¨ã‚¹ã‚­ãƒƒãƒ—ï¼‰</div>
      <div class="checkboxes">
        <label>
          <input type="checkbox" id="cb-section-header" checked>
          <span class="feature-num">1</span>
          ## --- â†’ ç« è¦‹å‡ºã—å¤‰æ›
        </label>
        <label>
          <input type="checkbox" id="cb-image" checked>
          <span class="feature-num">2</span>
          Imageã‚¿ã‚° â†’ LaTeX å¤‰æ›
        </label>
        <label>
          <input type="checkbox" id="cb-base64" checked>
          <span class="feature-num">3</span>
          Base64 ç”»åƒãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        </label>
        <label>
          <input type="checkbox" id="cb-annotation" checked>
          <span class="feature-num">4</span>
          æ³¨é‡ˆç•ªå·ã®å‰Šé™¤
        </label>
        <label>
          <input type="checkbox" id="cb-trailing-space" checked>
          <span class="feature-num">5</span>
          è¡Œæœ«ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤
        </label>
        <label>
          <input type="checkbox" id="cb-list-spacing" checked>
          <span class="feature-num">6</span>
          ãƒªã‚¹ãƒˆæ•´å½¢ï¼ˆç©ºè¡ŒæŒ¿å…¥ï¼‰
        </label>
        <label>
          <input type="checkbox" id="cb-list-br" checked>
          <span class="feature-num">7</span>
          ãƒªã‚¹ãƒˆæœ«å°¾ã¸ &lt;br&gt;&lt;br&gt; æŒ¿å…¥
        </label>
      </div>
    </div>
    <div class="btn-group">
      <button id="convert-btn">â–¶ å¤‰æ›</button>
      <button id="copy-btn" disabled>ğŸ“‹ å‡ºåŠ›ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <!-- Error -->
  <div id="error-msg"></div>

  <!-- Output -->
  <div class="output-section">
    <div class="output-label">å‡ºåŠ›çµæœ</div>
    <textarea id="output" readonly placeholder="ã€Œå¤‰æ›ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"></textarea>
  </div>

</main>

<script>
  'use strict';

  // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $latexInput    = document.getElementById('latex-input');
  const $markdownInput = document.getElementById('markdown-input');
  const $output        = document.getElementById('output');
  const $errorMsg      = document.getElementById('error-msg');
  const $convertBtn    = document.getElementById('convert-btn');
  const $copyBtn       = document.getElementById('copy-btn');
  const $cbSectionHeader = document.getElementById('cb-section-header');
  const $cbImage         = document.getElementById('cb-image');
  const $cbBase64        = document.getElementById('cb-base64');
  const $cbAnnotation    = document.getElementById('cb-annotation');
  const $cbTrailingSpace = document.getElementById('cb-trailing-space');
  const $cbListSpacing   = document.getElementById('cb-list-spacing');
  const $cbListBr        = document.getElementById('cb-list-br');

  // â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // msg ãŒç©ºæ–‡å­—ã®ã¨ãã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’æ¶ˆã™
  function setError(msg) {
    $errorMsg.textContent = msg;
    $errorMsg.style.display = msg ? 'block' : 'none';
  }

  // â”€â”€ æ©Ÿèƒ½1: ## --- â†’ ç« è¦‹å‡ºã—å¤‰æ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // "## ---" ã®è¡Œã¨ç›´å¾Œã®ç©ºè¡Œã‚’å‰Šé™¤ã—ã€æ¬¡ã®è¡Œã‚’ ## è¦‹å‡ºã—ã«å¤‰æ›ã™ã‚‹
  // ä¾‹: "## ---\n\n**ç¬¬2ç« ...**" â†’ "## **ç¬¬2ç« ...**"
  function convertSectionHeaders(text) {
    const lines  = text.split('\n');
    const result = [];
    let i = 0;
    while (i < lines.length) {
      if (lines[i] === '## ---') {
        // æ¬¡ã®ç©ºã§ãªã„è¡Œã‚’æ¢ã™
        let j = i + 1;
        while (j < lines.length && lines[j].trim() === '') j++;
        if (j < lines.length) {
          result.push('## ' + lines[j].trim());
          i = j + 1;
          continue;
        }
      }
      result.push(lines[i]);
      i++;
    }
    return result.join('\n');
  }

  // â”€â”€ æ©Ÿèƒ½2: Imageã‚¿ã‚°ã®LaTeXå½¢å¼ã¸ã®å¤‰æ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // $$...$$ ã¯æ”¹è¡Œã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ [\s\S]ã€å…ˆã«ãƒãƒƒãƒã•ã›ã‚‹
  // $...$ ã¯åŒä¸€è¡Œå†…ã«é™å®šï¼ˆæ”¹è¡Œãƒ»$ ã‚’å†…éƒ¨ã«å«ã¾ãªã„ï¼‰
  function extractLatex(text) {
    const results = [];
    const regex = /\$\$[\s\S]+?\$\$|\$[^$\n]+?\$/g;
    let match;
    while ((match = regex.exec(text)) !== null) {
      results.push(match[0]);
    }
    return results;
  }

  function convertImageTags(latexText, markdownText) {
    const latexCodes    = extractLatex(latexText);
    const imageTagCount = (markdownText.match(/!\[\]\[image\d+\]/g) || []).length;

    if (latexCodes.length !== imageTagCount) {
      throw new Error(
        `LaTeXã‚³ãƒ¼ãƒ‰æ•°ï¼ˆ${latexCodes.length}å€‹ï¼‰ã¨ç”»åƒã‚¿ã‚°æ•°ï¼ˆ${imageTagCount}å€‹ï¼‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚\n` +
        `å·¦ãƒšã‚¤ãƒ³ã® LaTeX å¼ã®æ•°ã¨å³ãƒšã‚¤ãƒ³ã® ![][imageX] ã‚¿ã‚°ã®æ•°ã‚’åˆã‚ã›ã¦ãã ã•ã„ã€‚`
      );
    }

    let idx = 0;
    return markdownText.replace(/!\[\]\[image\d+\]/g, () => latexCodes[idx++]);
  }

  // â”€â”€ æ©Ÿèƒ½2: Base64 ç”»åƒãƒ‡ãƒ¼ã‚¿å‰Šé™¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function deleteBase64(text) {
    return text.replace(/^\[image\d+\]:\s*<data:image\/[^>]*>\s*$/gm, '');
  }

  // â”€â”€ æ©Ÿèƒ½3: æ³¨é‡ˆç•ªå·ã®å‰Šé™¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ã€Œæ³¨é‡ˆã€ã€Œå‚è€ƒæ–‡çŒ®ã€ã€Œè„šæ³¨ã€ã®è¦‹å‡ºã—ä»¥é™ã¯å¯¾è±¡å¤–
  function deleteAnnotations(text) {
    const sectionMatch = /^#{1,6}\s*(æ³¨é‡ˆ|å‚è€ƒæ–‡çŒ®|è„šæ³¨)/m.exec(text);
    if (sectionMatch) {
      const body = text.slice(0, sectionMatch.index);
      const tail = text.slice(sectionMatch.index);
      return body.replace(/ ?\d{1,2}(?=ã€‚)/g, '') + tail;
    }
    return text.replace(/ ?\d{1,2}(?=ã€‚)/g, '');
  }

  // â”€â”€ æ©Ÿèƒ½4: è¡Œæœ«ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤ï¼ˆåŠè§’ã®ã¿ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function deleteTrailingSpaces(text) {
    return text.replace(/[ \t]+$/gm, '');
  }

  // â”€â”€ æ©Ÿèƒ½5: Markdownãƒªã‚¹ãƒˆã®ç©ºè¡ŒæŒ¿å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function insertListSpacing(text) {
    const lines  = text.split('\n');
    const result = [];
    for (let i = 0; i < lines.length; i++) {
      result.push(lines[i]);
      if (/^\* /.test(lines[i]) && i + 1 < lines.length && /^\* /.test(lines[i + 1])) {
        result.push('');
      }
    }
    return result.join('\n');
  }

  // â”€â”€ æ©Ÿèƒ½6: ãƒªã‚¹ãƒˆæœ«å°¾ã¸ã® <br><br> æŒ¿å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // æ©Ÿèƒ½5 ã§æŒ¿å…¥ã•ã‚ŒãŸç©ºè¡Œã‚’æŒŸã‚€å ´åˆã‚‚åŒä¸€ãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦æ‰±ã†
  // ãƒ–ãƒ­ãƒƒã‚¯å†…ã®æœ€å¾Œã®é …ç›®ã«ã¯è¿½åŠ ã—ãªã„
  function insertListBr(text) {
    const lines  = text.split('\n');
    const result = [];
    for (let i = 0; i < lines.length; i++) {
      if (/^\* /.test(lines[i])) {
        let j = i + 1;
        while (j < lines.length && lines[j].trim() === '') j++;
        if (j < lines.length && /^\* /.test(lines[j])) {
          result.push(lines[i] + '<br><br>');
          continue;
        }
      }
      result.push(lines[i]);
    }
    return result.join('\n');
  }

  // â”€â”€ å¤‰æ›å®Ÿè¡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $convertBtn.addEventListener('click', () => {
    setError('');

    const latexText    = $latexInput.value;
    const markdownText = $markdownInput.value;

    if (!markdownText.trim()) {
      setError('âš  å³ãƒšã‚¤ãƒ³ï¼ˆMarkdownå…¥åŠ›ï¼‰ãŒç©ºã§ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ã‹ã‚‰å¤‰æ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    // æ¨å¥¨å‡¦ç†é †åºã«å¾“ã£ã¦å®Ÿè¡Œã€‚ãƒã‚§ãƒƒã‚¯ãŒå¤–ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½ã¯ã‚¹ã‚­ãƒƒãƒ—ã€‚
    const pipeline = [
      { cb: $cbSectionHeader, fn: convertSectionHeaders },
      { cb: $cbImage,         fn: (t) => convertImageTags(latexText, t) },
      { cb: $cbBase64,        fn: deleteBase64 },
      { cb: $cbAnnotation,    fn: deleteAnnotations },
      { cb: $cbTrailingSpace, fn: deleteTrailingSpaces },
      { cb: $cbListSpacing,   fn: insertListSpacing },
      { cb: $cbListBr,        fn: insertListBr },
    ];

    try {
      let text = markdownText;
      for (const { cb, fn } of pipeline) {
        if (cb.checked) text = fn(text);
      }
      $output.value    = text;
      $copyBtn.disabled = !text;
    } catch (e) {
      setError('âš  ' + e.message);
    }
  });

  // â”€â”€ ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ï¼ˆé¸æŠãƒ»ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function readFile(file, textareaEl) {
    // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä»¥å¤–ã¯ã‚¨ãƒ©ãƒ¼
    const isText = file.type.startsWith('text/') || /\.(txt|md|tex|latex)$/i.test(file.name);
    if (!isText) {
      setError(`âš  "${file.name}" ã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚.txt / .md / .tex ãªã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);
      return;
    }

    const reader = new FileReader();
    reader.onload  = (e) => { textareaEl.value = e.target.result; };
    reader.onerror = ()  => { setError('âš  ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); };
    reader.readAsText(file, 'UTF-8');
  }

  function setupFileInput(paneEl, btnEl, fileInputEl, textareaEl) {
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³
    btnEl.addEventListener('click', () => fileInputEl.click());
    fileInputEl.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) readFile(file, textareaEl);
      fileInputEl.value = ''; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
    // dragenterã¨dragleaveã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§å­è¦ç´ ã‚’ã¾ãŸã„ã§ã‚‚æ­£ã—ããƒã‚¤ãƒ©ã‚¤ãƒˆã‚’åˆ¶å¾¡ã™ã‚‹
    let dragCount = 0;
    paneEl.addEventListener('dragenter', (e) => {
      e.preventDefault();
      dragCount++;
      paneEl.classList.add('drag-over');
    });
    paneEl.addEventListener('dragleave', () => {
      dragCount--;
      if (dragCount === 0) paneEl.classList.remove('drag-over');
    });
    paneEl.addEventListener('dragover', (e) => {
      e.preventDefault(); // drop ã‚’è¨±å¯ã™ã‚‹ãŸã‚ã«å¿…è¦
    });
    paneEl.addEventListener('drop', (e) => {
      e.preventDefault();
      dragCount = 0;
      paneEl.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file) readFile(file, textareaEl);
    });
  }

  setupFileInput(
    document.getElementById('latex-pane'),
    document.getElementById('latex-file-btn'),
    document.getElementById('latex-file-input'),
    $latexInput
  );
  setupFileInput(
    document.getElementById('markdown-pane'),
    document.getElementById('markdown-file-btn'),
    document.getElementById('markdown-file-input'),
    $markdownInput
  );

  // â”€â”€ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $copyBtn.addEventListener('click', (e) => {
    const text = $output.value;
    if (!text) return;

    navigator.clipboard.writeText(text).then(() => {
      const btn  = e.currentTarget;
      const prev = btn.textContent;
      btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
      setTimeout(() => { btn.textContent = prev; }, 1800);
    }).catch(() => {
      // Clipboard API éå¯¾å¿œç’°å¢ƒå‘ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      $output.select();
      document.execCommand('copy');
    });
  });
</script>

</body>
</html>
